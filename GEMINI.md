# SES AI ASSISTANT Core Library - Development Guidelines

## 1. プロジェクト概要
本プロジェクトは、SES AI ASSISTANT システムのバックエンドで共通的に利用されるJavaライブラリです。
RDB/NoSQL（DynamoDB）のエンティティ定義、ドメインロジックの最小単位（Unit）、および外部サービス（AWS, LLM, Slack等）との通信を担います。

## 2. 設計思想・アーキテクチャ
既存の設計思想を厳格に遵守し、システム全体の整合性を保つことを最優先とします。

### 2.1 データベース・エンティティ（database パッケージ）
- **Entity/Lot パターン**: 
    - 単一レコードを表す `SES_AI_...` クラスと、そのリストおよび操作を管理する `SES_AI_...Lot` クラスが対になっています。
    - 新しいテーブルを追加する場合は、`EntityBase` または `SES_AI_T_EntityBase` を継承し、必ず対応する `Lot` クラスを作成してください。
- **DynamoDB対応**: 
    - `database.base.DynamoDB` を基底とした抽象化を利用し、RDBと一貫性のある操作感を目指しています。

### 2.2 ドメイン・ユニット（unit パッケージ）
- **Value Object の徹底**: 
    - `Money`, `Currency`, `OriginalDateTime` など、値とロジックをカプセル化したクラス（Domain Primitive）を積極的に利用してください。
    - プリミティブ型（String, int等）を直接扱うのではなく、可能な限り `unit` パッケージのクラスへ変換して扱います。

### 2.3 外部API連携（api パッケージ）
- **抽象化レイヤー**: 
    - LLM（OpenAI, Gemini）などは `Transformer` や `GptModel` といったインターフェース/抽象クラスを介して利用します。
    - 特定のベンダーに依存した実装を直接ビジネスロジックに書かず、`api` パッケージ内のプロキシクラスを通してください。

## 3. 実装ルール
- **命名規則**: 
    - クラス名は既存の `SES_AI_` プレフィックスや、用途に応じた接尾辞（Lot, Tests）を遵守してください。
- **エラーハンドリング**: 
    - `logback.xml` の設定に基づき、適切なログレベルで記録してください。例外を握り潰さず、上位レイヤーに適切に伝播させるか、ドメイン例外にラップしてください。
- **型安全**: 
    - ジェネリクスを適切に使用し、ランタイムエラーを最小限に抑える実装を心がけてください。

## 4. テスト方針
- **回帰テストの重視**: 
    - 既存の `src/test/java` 内のテストケース（`GeminiTests`, `SES_AI_...Tests`等）を、修正後に必ず実行し、デグレードがないことを確認してください。
- **新規実装時のテスト**: 
    - 新機能やバグ修正を行う際は、必ず対応するテストクラスを `src/test/java` に作成または追加してください。

## 5. メンテナンス時の注意点
- **依存関係**: `pom.xml` を確認し、ライブラリの追加が必要な場合は既存のバージョンとの競合に注意してください。
- **共通性**: 特定のアプリケーションに特化したロジックはここには含めず、常に「複数システムで再利用可能か」を基準に判断してください。

## 6. AI Agent 運用ルール（必須）
Gemini CLIが本プロジェクトのコードを生成・修正する際は、以下のワークフローを厳守してください。
また、やりとりは全て日本語で行ってください。

### 6.1 作業開始時の「儀式」（INSTRUCTION.md と TODO.md の活用）
1. **指示の確認と抽出**: 開発を開始する際は、まず `INSTRUCTION.md` を読み込み、**最も新しく追加された未完了のタスク**を特定してください。
2. **TODO.md への転記**: 特定したタスクを `TODO.md` に具体的なステップ（調査・実装・検証）として書き出し、現在の作業対象を明確にしてください。
3. **シングルタスクの徹底**: 同時に複数の大きなタスクを進めず、`TODO.md` に記載した現在のステップに全神経を集中させてください。
4. **完了後のクリーンアップ**: タスクが完了（検証まで成功）したら、実行した指示内容を `ARCHIVE_INSTRUCTIONS.md` に追記し、`INSTRUCTION.md` を次の指示が書けるよう初期状態（テンプレート）に戻してください。
5. **コンテキスト同期**: 開発を再開する際は必ず `read_file("TODO.md")` を行い、前回の状態を完全に把握してから行動してください。

### 6.2 思考の連鎖 (Chain of Thought) の強制
- **事前調査**: コードを書く前に、必ず以下の内容を調査・報告してください。
    - どの既存クラス（特に `unit` や `api` パッケージ）が再利用可能か。
    - 修正対象のファイルと、その影響範囲。
- **実装方針の提示**: `replace` や `write_file` を呼ぶ前に、実装のステップを箇条書きで提示してください。

### 6.3 実装の粒度と共通部品の優先
- **DRY原則と共通部品**: 
    - 新しいロジックを作る際は、まず `unit/` 内に既存のドメイン型がないか、`util/` に共通メソッドがないか確認してください。あればそれを優先して使用し、なければ共通部品としての切り出しを検討してください。
- **実装密度**: 
    - 1クラスの肥大化を避け、ビジネスロジックが複雑になる場合は `Lot` クラスや別のドメインサービスに適切に委譲してください。
- **差分更新の徹底**:
    - ファイル全体を書き換えるのではなく、可能な限り `replace` ツールを使用して、修正が必要なメソッドやブロック単位で正確に変更を適用してください。

### 6.4 自律的検証
- **自動テスト**: 修正後は必ず関連するテストコードを実行（`mvn test` 等）し、成功を確認してください。
- **リファクタリング**: テスト通過後、命名規則やコードの綺麗さがプロジェクトの掟に沿っているかセルフチェックを行ってください。
